<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Sessions - CodeMentorHub</title>
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/admin.css' %}">
</head>
<body>
    <div class="layout">
        {% include 'admin/partials/sidebar.html' %}

        <main class="content">
            <h1>Manage Sessions</h1>
            
            <div class="section">
                <h3>Filter & Search</h3>
                <div class="search-box">
                    <form method="GET" style="display: flex; gap: 10px; width: 100%;">
                        <input 
                            type="text" 
                            name="q" 
                            placeholder="Search by mentor name, mentee email/username..." 
                            value="{{ search }}"
                            style="flex: 1;"
                        >
                        <select name="status">
                            <option value="">All Statuses</option>
                            <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
                            <option value="confirmed" {% if status_filter == 'confirmed' %}selected{% endif %}>Confirmed</option>
                            <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Completed</option>
                            <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Cancelled</option>
                        </select>
                        <button type="submit">Search</button>
                    </form>
                </div>
            </div>

            <div class="section">
                {% if sessions %}
                    <table class="session-table">
                        <thead>
                            <tr>
                                <th>Mentor</th>
                                <th>Mentee</th>
                                <th>Date & Time</th>
                                <th>Duration</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Meeting Link</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for session in sessions %}
                                <tr>
                                    <td>
                                        <div class="session-date">{{ session.mentor.full_name }}</div>
                                        <div class="user-info">{{ session.mentor.headline }}</div>
                                    </td>
                                    <td>
                                        <div class="session-date">{{ session.mentee.first_name|default:session.mentee.username }}</div>
                                        <div class="user-info">{{ session.mentee.email }}</div>
                                        <div class="user-info">@{{ session.mentee.username }}</div>
                                    </td>
                                    <td>
                                        <div class="session-date">{{ session.session_date|date:"M d, Y" }}</div>
                                        <div class="user-info">{{ session.session_time|time:"H:i" }}</div>
                                    </td>
                                    <td>{{ session.duration_minutes }} min</td>
                                    <td>${{ session.amount_paid }}</td>
                                    <td>
                                        <span class="status-badge status-{{ session.status }}">
                                            {{ session.get_status_display }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if session.meeting_link or session.admin_provided_link %}
                                            <a href="{{ session.get_meeting_link }}" target="_blank" style="color: #007bff; text-decoration: none; word-break: break-all;">
                                                <strong>ðŸ“¹ Join Meeting</strong>
                                            </a>
                                        {% else %}
                                            <span style="color: #999; font-size: 12px;">Not provided yet</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                                            {% if session.status != 'completed' and session.status != 'cancelled' %}
                                                <form method="POST" action="{% url 'admin_session_set_status' session.id %}" style="display: inline;">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="action" value="completed">
                                                    <button type="submit" class="action-btn btn-complete" onclick="return confirm('Mark this session as completed?')">
                                                        âœ“ Complete
                                                    </button>
                                                </form>
                                                <form method="POST" action="{% url 'admin_session_set_status' session.id %}" style="display: inline;">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="action" value="cancelled">
                                                    <button type="submit" class="action-btn btn-cancel" onclick="return confirm('Cancel this session?')">
                                                        âœ— Cancel
                                                    </button>
                                                </form>
                                            {% endif %}
                                            {% if session.status == 'pending' and session.status != 'confirmed' %}
                                                <button type="button" class="action-btn btn-confirm" onclick="openMeetingLinkModal({{ session.id }})">
                                                    â—‡ Confirm with Link
                                                </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    {% if sessions.has_other_pages %}
                        <div class="pagination">
                            {% if sessions.has_previous %}
                                <a href="?page=1&q={{ search }}&status={{ status_filter }}">Â« First</a>
                                <a href="?page={{ sessions.previous_page_number }}&q={{ search }}&status={{ status_filter }}">â€¹ Previous</a>
                            {% endif %}

                            <span style="margin: 0 10px;">
                                Page {{ sessions.number }} of {{ sessions.paginator.num_pages }}
                            </span>

                            {% if sessions.has_next %}
                                <a href="?page={{ sessions.next_page_number }}&q={{ search }}&status={{ status_filter }}">Next â€º</a>
                                <a href="?page={{ sessions.paginator.num_pages }}&q={{ search }}&status={{ status_filter }}">Last Â»</a>
                            {% endif %}
                        </div>
                    {% endif %}
                {% else %}
                    <div class="empty-state">
                        <h3>No sessions found</h3>
                        <p>There are no sessions matching your criteria.</p>
                    </div>
                {% endif %}
            </div>
        </main>
    </div>

    <!-- Modal for entering Google Meet link -->
    <div id="meetingLinkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Provide Google Meet Link</h3>
                <button type="button" onclick="closeMeetingLinkModal()" style="float: right; background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            <form id="linkForm" method="POST" style="clear: both;">
                {% csrf_token %}
                <input type="hidden" id="sessionId" name="session_id" value="">
                <input type="hidden" name="action" value="confirmed">
                
                <label for="meetingLink" style="display: block; margin-bottom: 10px; font-weight: 600;">
                    Google Meet Link:
                </label>
                <input 
                    type="url" 
                    id="meetingLink" 
                    name="meeting_link" 
                    placeholder="https://meet.google.com/..." 
                    required
                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px; box-sizing: border-box;"
                >
                
                <div class="modal-buttons">
                    <button type="button" class="btn-cancel-modal" onclick="closeMeetingLinkModal()">Cancel</button>
                    <button type="submit" class="btn-confirm-action">Confirm & Send Link</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function openMeetingLinkModal(sessionId) {
            document.getElementById('sessionId').value = sessionId;
            document.getElementById('meetingLink').value = '';
            document.getElementById('meetingLinkModal').classList.add('show');
        }
        
        function closeMeetingLinkModal() {
            document.getElementById('meetingLinkModal').classList.remove('show');
        }
        
        document.getElementById('linkForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const sessionId = document.getElementById('sessionId').value;
            const form = this;
            
            // Change form action to the correct URL
            form.action = `/admin/sessions/${sessionId}/set-status/`;
            form.submit();
        });
        
        // Close modal if clicking outside of it
        document.getElementById('meetingLinkModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeMeetingLinkModal();
            }
        });
    </script>
</body>
</html>
